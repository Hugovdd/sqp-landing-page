---
import { getEntry } from "astro:content";

import { AESheetsFeatures } from "@/components/blocks/ae-sheets-features";
import { Background } from "@/components/background";
import { CTASection } from "@/components/blocks/cta-section";
import { FAQ } from "@/components/blocks/faq";
import { ProductHero } from "@/components/blocks/product-hero";
import { TechStack } from "@/components/blocks/tech-stack";
import { TimeSavingsCalculator } from "@/components/blocks/time-savings-calculator";
import { TutorialVideo } from "@/components/blocks/tutorial-video";
import AnimateOnScroll from "@/components/AnimateOnScroll.astro";
import StructuredData from "@/components/StructuredData.astro";
import DefaultLayout from "@/layouts/DefaultLayout.astro";
import {
  buildFAQSchema,
  buildOrganizationSchema,
  buildProductSchema,
} from "@/lib/seo";

const product = await getEntry("products", "ae-sheets");
if (!product) throw new Error("Product not found");

const { data } = product;
const productSchema = buildProductSchema(data);
const faqSchema = buildFAQSchema(data.faqs);
const orgSchema = buildOrganizationSchema();
---

<DefaultLayout
  title={data.seo.metaTitle}
  description={data.seo.metaDescription}
  ogImage={data.seo.ogImage}
  keywords={data.seo.keywords}
>
  <StructuredData slot="head" data={orgSchema} />
  <StructuredData slot="head" data={productSchema} />
  {faqSchema && <StructuredData slot="head" data={faqSchema} />}

  <!-- Force dark mode & radial reveal animation -->
  <script is:inline slot="head">
    (function() {
      // Remember the user's real theme so we can restore it when they leave
      var current = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (current !== 'dark') {
        sessionStorage.setItem('__ae_prev_theme', current);
      }
      // Switch to dark using the same mechanism as ThemeToggle
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');

      // Inject the radial reveal animation
      var s = document.createElement('style');
      s.textContent = '@keyframes radial-reveal{from{clip-path:circle(0% at 50% 0%)}to{clip-path:circle(150% at 50% 0%)}}body{animation:radial-reveal .8s cubic-bezier(.25,.46,.45,.94) forwards}';
      document.head.appendChild(s);

      // Remove clip-path once animation completes so it doesn't mask scrollable content
      document.addEventListener('DOMContentLoaded', function() {
        document.body.addEventListener('animationend', function handler(e) {
          if (e.animationName === 'radial-reveal') {
            document.body.style.animation = 'none';
            document.body.style.clipPath = 'none';
            document.body.removeEventListener('animationend', handler);
          }
        });
      });

      // Restore theme when the user navigates away
      window.addEventListener('beforeunload', function() {
        var prev = sessionStorage.getItem('__ae_prev_theme');
        if (prev) {
          localStorage.setItem('theme', prev);
          sessionStorage.removeItem('__ae_prev_theme');
        }
      });
    })();
  </script>

  <Background className="via-muted to-muted/80">
    <ProductHero
      client:load
      title={data.title}
      tagline={data.tagline}
      price={data.price}
      currency={data.currency}
      version={data.version}
      status={data.status}
      supportedApp={data.supportedApp}
      extensionType={data.extensionType}
      checkoutUrl={data.checkoutUrl}
      buyButtonLabel={data.buyButtonLabel}
      heroVideo={data.heroVideo}
      heroImage={data.heroImage}
      heroFeatures={data.heroFeatures}
      showDivider={false}
      mediaStyle="card"
    />
  </Background>

  <AnimateOnScroll animation="fade-up">
    <AESheetsFeatures />
  </AnimateOnScroll>

  {data.tutorialVideoId && (
    <AnimateOnScroll animation="fade-up">
      <TutorialVideo
        youtubeId={data.tutorialVideoId}
        heading="See it in action"
        description="Watch a full walkthrough of AE Sheets to see how it fits into your localization workflow."
        className="pt-10 lg:pt-12"
      />
    </AnimateOnScroll>
  )}

  <AnimateOnScroll animation="fade-up">
    <TimeSavingsCalculator client:visible />
  </AnimateOnScroll>

  {data.faqs.length > 0 && (
    <FAQ client:only="react" items={data.faqs} />
  )}

  <AnimateOnScroll animation="fade-up">
    <TechStack items={data.techStack} heading="Built with" />
  </AnimateOnScroll>

  <AnimateOnScroll animation="fade-up">
    <CTASection
      title={data.title}
      tagline={data.tagline}
      price={data.price}
      currency={data.currency}
      status={data.status}
      checkoutUrl={data.checkoutUrl}
      stats={data.stats}
      heading="Turn a day of grunt work into a coffee break."
      description="Translate, restyle, and batch-export every language version without touching a single layer by hand."
      buttonLabel="Stop doing it the hard way â€” $69"
    />
  </AnimateOnScroll>
</DefaultLayout>
