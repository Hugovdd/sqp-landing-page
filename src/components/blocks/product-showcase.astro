---
import { Image } from "astro:assets";
import { ArrowRight } from "lucide-react";

import { Badge } from "@/components/ui/badge";
import { buttonVariants } from "@/components/ui/button";
import { FeatureChips } from "@/components/blocks/feature-chips";
import { cn } from "@/lib/utils";

interface Product {
  id: string;
  title: string;
  tagline: string;
  price: number;
  currency: string;
  status: "available" | "coming_soon" | "discontinued";
  category: "extension" | "plugin" | "script" | "freebie";
  heroImage?: string;
  slug: string;
  checkoutUrl?: string;
  buyButtonLabel?: string;
  features?: { icon: string; title: string; description?: string }[];
}

interface ProductShowcaseProps {
  products: Product[];
  heading?: string;
  description?: string;
  className?: string;
}

const { products, heading, description, className } =
  Astro.props as ProductShowcaseProps;

const placeholderImages = [
  "https://static.wixstatic.com/media/7e521c_b0ef000940f94f8dab0d3717447e7ce7~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Default%20mode.jpg",
  "https://static.wixstatic.com/media/7e521c_6a3aacc163064dc8a2dbb53e4d6fe913~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Ready%20to%20use%2C%20instantly.jpg",
  "https://static.wixstatic.com/media/7e521c_22eddcf7e947417f80b180080d1fc70a~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Real%20backed%2C%20real%20results.jpg",
];

const sectionGridClass =
  "w-full mx-auto grid box-border pt-[16.67vw] pr-[5.6vw] pb-[16.67vw] pl-[5.6vw] gap-[7vw] md:pt-[14.3vw] md:pr-[6.5vw] md:pb-[14.3vw] md:pl-[6.5vw] md:gap-[3vw] lg:pt-[6.8vw] lg:px-[6.5vw] lg:pb-[7.65vw] lg:gap-[1.5vw] xl:px-[7.8125vw]";
const headerClass =
  "w-full mx-auto grid justify-items-center text-center gap-[2vw] mb-[4vw] md:mb-[3vw] lg:w-[40vw] lg:gap-[1.2vw] lg:mb-[2.5vw]";
const headingClass =
  "m-0 text-foreground font-semibold leading-[1.1] tracking-[-0.02em] text-[clamp(1.875rem,8.3vw,2.4rem)] md:text-[clamp(2.2rem,7.55vw,3.625rem)] lg:text-[clamp(2.5rem,3.75vw,4.5rem)]";
const bodyTextClass =
  "m-0 text-muted-foreground leading-[1.4] text-[clamp(1rem,4.44vw,1.2rem)] md:text-[clamp(1rem,2.6vw,1.25rem)] lg:text-[clamp(1rem,1.041vw,1.25rem)]";
const articleClass =
  "grid grid-cols-1 relative lg:grid-cols-[0.9975fr_1fr] lg:sticky lg:top-[8vw]";
const imageClass =
  "block w-full object-cover h-[73.9vw] rounded-[14px] md:h-[59.9vw] md:rounded-[20px] lg:h-full lg:rounded-[40px]";
const contentCardClass =
  "bg-[#faf9f7] dark:bg-card grid content-center rounded-[14px] py-[6.945vw] px-[7.6vw] gap-[3.88vw] md:min-h-[59.9vw] md:pt-[6.77vw] md:px-[4.2vw] md:pb-[6vw] md:gap-[3.35vw] md:rounded-[20px] lg:min-h-0 lg:py-0 lg:px-[4.36vw] lg:gap-[1.35vw] lg:rounded-[40px]";
const contentStackClass = "flex flex-col gap-[1.90rem] lg:gap-[1.08vw]";
const titleClass =
  "font-display m-0 text-foreground font-normal leading-[1.1] tracking-[-0.02em] text-[clamp(1.5rem,6.8vw,2.1rem)] md:text-[clamp(1.875rem,5.8vw,2.75rem)] lg:text-[clamp(1.875rem,3.1vw,2.8rem)] xl:text-[clamp(2rem,2.7vw,3.4rem)] 2xl:text-[clamp(2.1rem,2.3vw,3.2rem)]";
const featureChipsClass = "gap-y-2.5 lg:hidden xl:grid xl:w-[28.6vw]";
const actionRowClass = "flex flex-col items-stretch gap-4 mt-2 xl:flex-row xl:items-center";
const ctaButtonClass = "rounded-full px-8";
---

<section class={cn("relative", className)}>
  <div class={sectionGridClass}>
    {(heading || description) && (
      <header class={headerClass}>
        {heading && (
          <h2 class={headingClass}>
            {heading}
          </h2>
        )}
        {description && (
          <p class={bodyTextClass}>
            {description}
          </p>
        )}
      </header>
    )}

    {products.map((product, index) => {
      const isReversed = index % 2 === 0;
      const zIndex = 20 + (index + 1) * 10;
      const image = product.heroImage ?? placeholderImages[index % placeholderImages.length];
      const formattedPrice =
        product.price === 0
          ? "Free"
          : new Intl.NumberFormat("en-US", {
              style: "currency",
              currency: product.currency,
              minimumFractionDigits: 0,
            }).format(product.price);

      return (
        <article
          class={articleClass}
          style={`z-index: ${zIndex};`}
        >
          <Image
            src={image}
            alt={`${product.title} preview`}
            width={972}
            height={708}
            sizes="(min-width: 1024px) 50vw, 100vw"
            loading="lazy"
            class={cn(
              imageClass,
              isReversed && "lg:order-2"
            )}
          />

          <div class={contentCardClass}>
            <div class={contentStackClass}>
              <div class="flex items-center gap-2">
                <Badge variant="outline" className="text-xs capitalize max-2xl:hidden">
                  {product.category}
                </Badge>
                {product.status === "coming_soon" && (
                  <Badge variant="secondary" className="text-xs uppercase">
                    Coming Soon
                  </Badge>
                )}
              </div>

              <h3 class={titleClass}>
                {product.title}
              </h3>

              <p class={cn(bodyTextClass, "w-full")}>
                {product.tagline}
              </p>

              {product.features && product.features.length > 0 && (
                <FeatureChips features={product.features} className={featureChipsClass} />
              )}

              <div class={actionRowClass}>
                <a
                  href={product.checkoutUrl ?? product.slug}
                  class={cn(
                    buttonVariants({ size: "lg" }),
                    ctaButtonClass,
                    !product.buyButtonLabel && "lemonsqueezy-button"
                  )}
                  {...(product.buyButtonLabel ? { target: "_blank", rel: "noopener noreferrer" } : {})}
                >
                  {product.status === "coming_soon"
                    ? "Coming Soon"
                    : (product.buyButtonLabel ?? `Get for ${formattedPrice}`)}
                </a>
                <a
                  href={product.slug}
                  class={cn(
                    buttonVariants({ size: "lg", variant: "outline" }),
                    ctaButtonClass
                  )}
                >
                  Find out more
                  <ArrowRight className="ml-2 size-4" />
                </a>
              </div>
            </div>
          </div>
        </article>
      );
    })}
  </div>
</section>
