---
import { Image } from "astro:assets";
import { ArrowRight } from "lucide-react";

import { Badge } from "@/components/ui/badge";
import { buttonVariants } from "@/components/ui/button";
import { FeatureChips } from "@/components/blocks/feature-chips";
import { cn } from "@/lib/utils";

interface Product {
  id: string;
  title: string;
  tagline: string;
  price: number;
  currency: string;
  status: "available" | "coming_soon" | "discontinued";
  category: "extension" | "plugin" | "script" | "freebie";
  heroImage?: string;
  slug: string;
  checkoutUrl?: string;
  buyButtonLabel?: string;
  features?: { icon: string; title: string; description?: string }[];
}

interface ProductShowcaseProps {
  products: Product[];
  heading?: string;
  description?: string;
  className?: string;
}

const { products, heading, description, className } =
  Astro.props as ProductShowcaseProps;

const placeholderImages = [
  "https://static.wixstatic.com/media/7e521c_b0ef000940f94f8dab0d3717447e7ce7~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Default%20mode.jpg",
  "https://static.wixstatic.com/media/7e521c_6a3aacc163064dc8a2dbb53e4d6fe913~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Ready%20to%20use%2C%20instantly.jpg",
  "https://static.wixstatic.com/media/7e521c_22eddcf7e947417f80b180080d1fc70a~mv2.jpg/v1/fill/w_972,h_708,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Real%20backed%2C%20real%20results.jpg",
];
---

<section class={cn("relative", className)}>
  <div class="w-full mx-auto grid box-border pt-[16.67vw] pr-[5.6vw] pb-[16.67vw] pl-[5.6vw] gap-[7vw] md:pt-[14.3vw] md:pr-[6.5vw] md:pb-[14.3vw] md:pl-[6.5vw] md:gap-[3vw] desktop:pt-[6.8vw] desktop:pr-[7.8125vw] desktop:pb-[7.65vw] desktop:pl-[7.8125vw] desktop:gap-[1.5vw]">
    {(heading || description) && (
      <header class="w-full mx-auto grid justify-items-center text-center gap-[2vw] mb-[4vw] md:mb-[3vw] desktop:w-[40vw] desktop:gap-[1.2vw] desktop:mb-[2.5vw]">
        {heading && (
          <h2 class="m-0 text-foreground font-semibold leading-[1.1] tracking-[-0.02em] text-[clamp(1.875rem,8.3vw,2.4rem)] md:text-[clamp(2.2rem,7.55vw,3.625rem)] desktop:text-[clamp(2.5rem,3.75vw,4.5rem)]">
            {heading}
          </h2>
        )}
        {description && (
          <p class="m-0 text-muted-foreground leading-[1.4] text-[clamp(1rem,4.44vw,1.2rem)] md:text-[clamp(1rem,2.6vw,1.25rem)] desktop:text-[clamp(1rem,1.041vw,1.25rem)]">
            {description}
          </p>
        )}
      </header>
    )}

    {products.map((product, index) => {
      const isReversed = index % 2 === 0;
      const zIndex = 20 + (index + 1) * 10;
      const image = product.heroImage ?? placeholderImages[index % placeholderImages.length];
      const formattedPrice =
        product.price === 0
          ? "Free"
          : new Intl.NumberFormat("en-US", {
              style: "currency",
              currency: product.currency,
              minimumFractionDigits: 0,
            }).format(product.price);

      return (
        <article
          class="grid grid-cols-1 relative desktop:grid-cols-[0.9975fr_1fr] desktop:sticky desktop:top-[8vw]"
          style={`z-index: ${zIndex};`}
        >
          <Image
            src={image}
            alt={`${product.title} preview`}
            width={972}
            height={708}
            sizes="(min-width: 1100px) 50vw, 100vw"
            loading="lazy"
            class={cn(
              "block w-full h-auto rounded-[14px] md:rounded-[20px] desktop:rounded-[40px]",
              isReversed && "desktop:order-2"
            )}
          />

          <div class="bg-[#faf9f7] dark:bg-card grid content-center rounded-[14px] py-[13.89vw] px-[8.33vw] gap-[3.88vw] md:pt-[6.77vw] md:pr-[4vw] md:pb-[6vw] md:pl-[5.2vw] md:gap-[3.35vw] md:rounded-[20px] desktop:min-h-0 desktop:py-0 desktop:pr-[6.61vw] desktop:pl-[5.21vw] desktop:gap-[1.35vw] desktop:rounded-[40px]">
            <div class="flex flex-col gap-4 desktop:gap-[1.35vw]">
              <div class="flex items-center gap-2">
                <Badge variant="outline" className="text-xs capitalize">
                  {product.category}
                </Badge>
                {product.status === "coming_soon" && (
                  <Badge variant="secondary" className="text-xs uppercase">
                    Coming Soon
                  </Badge>
                )}
              </div>

              <h3 class="font-display m-0 text-foreground font-normal leading-[1.1] tracking-[-0.02em] text-[clamp(1.625rem,7.2vw,2.25rem)] md:text-[clamp(2rem,6.25vw,3rem)] desktop:text-[clamp(2rem,3.33vw,4rem)]">
                {product.title}
              </h3>

              <p class="m-0 w-full text-muted-foreground leading-[1.4] text-[clamp(1rem,4.44vw,1.2rem)] md:text-[clamp(1rem,2.6vw,1.25rem)] desktop:w-[22vw] desktop:text-[clamp(1rem,1.041vw,1.25rem)]">
                {product.tagline}
              </p>

              {product.features && product.features.length > 0 && (
                <FeatureChips features={product.features} className="gap-y-2.5 desktop:w-[22vw]" />
              )}

              <div class="flex items-center gap-4 mt-2">
                <a
                  href={product.checkoutUrl ?? product.slug}
                  class={cn(
                    buttonVariants({ size: "lg" }),
                    "rounded-full px-8",
                    !product.buyButtonLabel && "lemonsqueezy-button"
                  )}
                  {...(product.buyButtonLabel ? { target: "_blank", rel: "noopener noreferrer" } : {})}
                >
                  {product.status === "coming_soon"
                    ? "Coming Soon"
                    : (product.buyButtonLabel ?? `Get for ${formattedPrice}`)}
                </a>
                <a
                  href={product.slug}
                  class={cn(
                    buttonVariants({ size: "lg", variant: "outline" }),
                    "rounded-full px-8"
                  )}
                >
                  Find out more
                  <ArrowRight className="ml-2 size-4" />
                </a>
              </div>
            </div>
          </div>
        </article>
      );
    })}
  </div>
</section>
